server.port=${SERVER_PORT:8081}

spring.security.oauth2.client.registration.keycloak.client-id=${OAUTH2_CLIENT_ID:springboot-app}
spring.security.oauth2.client.registration.keycloak.client-secret=${OAUTH2_CLIENT_SECRET:X5YEeCMX3GL6BrEzVsfH0RR5jbh6qJKU}
spring.security.oauth2.client.registration.keycloak.scope=openid,profile,email
spring.security.oauth2.client.registration.keycloak.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.keycloak.redirect-uri={baseUrl}/login/oauth2/code/{registrationId}


# Provider endpoints - manually configure all endpoints (no issuer-uri = no auto-discovery)
# Authorization URI uses HTTPS for browser redirect, all others use internal Docker service name
spring.security.oauth2.client.provider.keycloak.issuer-uri=http://keycloak:8080/realms/myrealm
spring.security.oauth2.client.provider.keycloak.authorization-uri=https://auth.keycloak-demo.local/realms/myrealm/protocol/openid-connect/auth
spring.security.oauth2.client.provider.keycloak.token-uri=http://keycloak:8080/realms/myrealm/protocol/openid-connect/token
spring.security.oauth2.client.provider.keycloak.jwk-set-uri=http://keycloak:8080/realms/myrealm/protocol/openid-connect/certs
spring.security.oauth2.client.provider.keycloak.user-info-uri=http://keycloak:8080/realms/myrealm/protocol/openid-connect/userinfo
spring.security.oauth2.client.provider.keycloak.user-name-attribute=preferred_username

# Backend service URL using Docker service name (internal communication)
backend.url=${BACKEND_URL:http://backend:8082}

# Session configuration to prevent authorization_request_not_found errors
server.servlet.session.cookie.same-site=lax
server.servlet.session.timeout=30m
server.servlet.session.cookie.http-only=true
server.servlet.session.cookie.secure=true

# Trust reverse proxy headers for HTTPS detection
server.forward-headers-strategy=NATIVE

# Fix: templates are located under `classpath:/template/` (not `templates`)
spring.thymeleaf.prefix=classpath:/template/
# Enable debug logging for OAuth2
logging.level.org.springframework.security=DEBUG
logging.level.org.springframework.security.oauth2=DEBUG

# Actuator endpoints
management.endpoints.web.exposure.include=health,info,metrics,circuitbreakers,circuitbreakerevents
management.endpoint.health.show-details=when-authorized
management.health.circuitbreakers.enabled=true
logging.level.root=INFO

# Resilience4j Circuit Breaker Configuration
resilience4j.circuitbreaker.configs.default.slidingWindowSize=10
resilience4j.circuitbreaker.configs.default.minimumNumberOfCalls=5
resilience4j.circuitbreaker.configs.default.permittedNumberOfCallsInHalfOpenState=3
resilience4j.circuitbreaker.configs.default.waitDurationInOpenState=60s
resilience4j.circuitbreaker.configs.default.failureRateThreshold=50
resilience4j.circuitbreaker.configs.default.slowCallRateThreshold=50
resilience4j.circuitbreaker.configs.default.slowCallDurationThreshold=5s
resilience4j.circuitbreaker.configs.default.registerHealthIndicator=true

resilience4j.circuitbreaker.instances.backendService.baseConfig=default

# Resilience4j Retry Configuration
resilience4j.retry.configs.default.maxAttempts=3
resilience4j.retry.configs.default.waitDuration=2s
resilience4j.retry.configs.default.retryExceptions=org.springframework.web.reactive.function.client.WebClientRequestException,java.util.concurrent.TimeoutException
resilience4j.retry.configs.default.ignoreExceptions=org.springframework.web.reactive.function.client.WebClientResponseException.Unauthorized,org.springframework.web.reactive.function.client.WebClientResponseException.Forbidden

resilience4j.retry.instances.backendService.baseConfig=default

# Resilience4j TimeLimiter Configuration  
resilience4j.timelimiter.configs.default.timeoutDuration=10s
resilience4j.timelimiter.instances.backendService.baseConfig=default

# Resilience4j Bulkhead Configuration (limits concurrent calls)
resilience4j.bulkhead.configs.default.maxConcurrentCalls=25
resilience4j.bulkhead.configs.default.maxWaitDuration=100ms
resilience4j.bulkhead.instances.backendService.baseConfig=default

# Logging configuration - TRACE for detailed OAuth2 debugging
logging.level.org.springframework.security=TRACE
logging.level.org.springframework.security.oauth2=TRACE
logging.level.org.springframework.web=DEBUG
logging.level.org.springframework.web.reactive.function.client=TRACE
logging.level.reactor.netty.http.client=DEBUG
